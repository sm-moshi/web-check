name: ðŸš€ Deploy to AWS

on:
  workflow_dispatch:
  push:
    branches:
      - master
    tags:
      - '*'
    paths:
      - api/**
      - serverless.yml
      - package.json
      - .github/workflows/deploy-aws.yml

jobs:
  deploy-api:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: 24.12.0

      - name: Cache node_modules
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5
        with:
          path: node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Create GitHub deployment for API
        uses: chrnorm/deployment-action@releases/v2
        id: deployment_api
        with:
          token: ${{ secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }}
          environment: AWS (Backend API)
          ref: ${{ github.ref }}

      - name: Install Serverless CLI and dependencies
        run: |
          npm i -g serverless
          yarn

      - name: Deploy to AWS
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: serverless deploy

      - name: Update GitHub deployment status (API)
        if: always()
        uses: chrnorm/deployment-status@9a72af4586197112e0491ea843682b5dc280d806 # v2
        with:
          token: ${{ secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }}
          state: "${{ job.status }}"
          deployment_id: ${{ steps.deployment_api.outputs.deployment_id }}
          ref: ${{ github.ref }}

  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: 24

      - name: Cache node_modules
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5
        with:
          path: node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Create GitHub deployment for Frontend
        uses: chrnorm/deployment-action@55729fcebec3d284f60f5bcabbd8376437d696b1 # v2
        id: deployment_frontend
        with:
          token: ${{ secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }}
          environment: AWS (Frontend Web UI)
          ref: ${{ github.ref }}

      - name: Install dependencies and build
        run: |
          yarn install
          yarn build

      - name: Setup AWS
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Upload to S3
        env:
          AWS_S3_BUCKET: 'web-check-frontend'
        run: aws s3 sync ./build/ s3://$AWS_S3_BUCKET/ --delete

      - name: Invalidate CloudFront cache
        uses: chetan/invalidate-cloudfront-action@12d242edc7752fca9140c2034be28792ad22c5a8 # v2
        env:
          DISTRIBUTION: E30XKAM2TG9FD8
          PATHS: '/*'
          AWS_REGION: 'us-east-1'
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Update GitHub deployment status (Frontend)
        if: always()
        uses: chrnorm/deployment-status@9a72af4586197112e0491ea843682b5dc280d806 # v2
        with:
          token: ${{ secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }}
          state: "${{ job.status }}"
          deployment_id: ${{ steps.deployment_frontend.outputs.deployment_id }}
          ref: ${{ github.ref }}
